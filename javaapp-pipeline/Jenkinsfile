pipeline {
    agent none

    environment {
        APP_NAME = "java-sample-21"
        AWS_REGION = "ap-southeast-1"
        AWS_ACCOUNT_ID = credentials('aws-account-id')  // stored in Jenkins
        ECR_REPO = "javaapp-image"
        IMAGE_URI = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${BUILD_NUMBER}"
    }

    stages {
        stage('Checkout') {
            agent { label 'sonar-trivy-agent' }
            steps {
                git branch: 'dev', url: 'https://github.com/DeviVaraPrasadJ-dev/jenkins.git'
            }
        }

        stage('Build & Test') {
            agent { label 'sonar-trivy-agent' }
            steps {
                dir('javaapp-pipeline') {
                    sh 'mvn clean package'
                    sh 'mvn test'
                }
            }
        }

        stage('SonarQube & Trivy FS Scan') {
            agent { label 'sonar-trivy-agent' }
            steps {
                withSonarQubeEnv('sonar') {
                    dir('javaapp-pipeline') {
                        sh '''
                          mvn sonar:sonar \
                            -Dsonar.projectKey=javaapp-pipeline \
                            -Dsonar.projectName="Java App Pipeline"
                        '''
                    }
                }
                dir('javaapp-pipeline') {
                    sh 'trivy fs --exit-code 0 --severity HIGH,CRITICAL .'
                }
            }
        }

        stage('Wait for Quality Gate') {
            agent { label 'sonar-trivy-agent' }
            steps {
                waitForQualityGate abortPipeline: true
            }
        }

        stage('Build Docker Image') {
            agent { label 'docker-agent' }
            steps {
                dir('javaapp-pipeline') {
                    sh "docker build -t ${IMAGE_URI} ."
                }
            }
        }

        stage('Trivy Image Scan') {
            agent { label 'docker-agent' }
            steps {
                sh "trivy image --exit-code 0 --severity HIGH,CRITICAL ${IMAGE_URI}"
            }
        }

        stage('Push to ECR') {
            agent { label 'docker-agent' }
            steps {
                withAWS(region: "${AWS_REGION}", credentials: 'aws-jenkins') {
                    sh """
                      aws ecr describe-repositories --repository-names ${ECR_REPO} \
                        || aws ecr create-repository --repository-name ${ECR_REPO}

                      aws ecr get-login-password --region ${AWS_REGION} | \
                        docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

                      docker push ${IMAGE_URI}
                    """
                }
            }
        }

        // stage('Deploy to ECS') {
        //     agent { label 'docker-agent' }
        //     steps {
        //         withAWS(region: "${AWS_REGION}", credentials: 'aws-jenkins') {
        //             sh """
        //               aws ecs update-service \
        //                 --cluster my-ecs-cluster \
        //                 --service my-ecs-service \
        //                 --force-new-deployment
        //             """
        //         }
        //     }
        // }
        stage('Deploy from ECR') {
            steps {
                sh '''
                    echo " Logging in to Amazon ECR..."
                    aws ecr get-login-password --region $AWS_REGION | \
                    docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com

                    echo " Pulling image from ECR..."
                    docker pull $ECR_URI

                    echo " Running container from ECR image..."

                    # Stop and remove existing container if it exists
                    docker rm -f javaapp-container || true

                    # Run the container on port 5000
                    docker run -d \
                        --name javaapp-container \
                        -p 5000:5000 \
                        $ECR_URI

                    echo " Container is running at http://localhost:5000"
                '''
            }
        }
    }
}
