pipeline {
  agent {
    kubernetes {
      defaultContainer 'maven'
      yaml """
apiVersion: v1
kind: Pod
metadata:
  annotations:
    jenkins.io/skip-container-readiness: "kaniko"
spec:
  serviceAccountName: jenkins
  restartPolicy: Never

  containers:

    - name: maven
      image: maven:3.9.6-eclipse-temurin-21
      command: ["cat"]
      tty: true
      resources:
        requests:
          cpu: "200m"
          memory: "512Mi"
        limits:
          cpu: "1"
          memory: "1Gi"
      volumeMounts:
        - name: workspace
          mountPath: /home/jenkins/agent

    - name: aws
      image: public.ecr.aws/aws-cli/aws-cli:latest
      command: ["cat"]
      tty: true
      env:
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: aws-creds
              key: aws_access_key_id
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: aws-creds
              key: aws_secret_access_key
        - name: AWS_REGION
          value: "ap-southeast-1"
      volumeMounts:
        - name: workspace
          mountPath: /home/jenkins/agent

    - name: helm
      image: dtzar/helm-kubectl:3.14.0
      command: ["cat"]
      tty: true
      volumeMounts:
        - name: workspace
          mountPath: /home/jenkins/agent

    - name: kaniko
      image: gcr.io/kaniko-project/executor:debug
      command: ["/busybox/sh"]
      args: ["-c", "sleep 3600"]
      tty: true
      env:
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: aws-creds
              key: aws_access_key_id

        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: aws-creds
              key: aws_secret_access_key

        - name: AWS_REGION
          value: "ap-southeast-1"
      volumeMounts:
        - name: workspace
          mountPath: /home/jenkins/agent
    
    - name: jnlp
      image: jenkins/inbound-agent:3345.v03dee9b_f88fc-1
      args: ["\$(JENKINS_SECRET)", "\$(JENKINS_NAME)"]
      volumeMounts:
        - name: workspace
          mountPath: /home/jenkins/agent
  volumes:
    - name: workspace
      emptyDir: {}
"""
    }
  }

  options {
    // prevents automatic default checkout: we perform checkout explicitly in the Checkout stage
    skipDefaultCheckout()

  }

  environment {
    AWS_REGION    = "ap-southeast-1"
    ECR_REGISTRY  = "197315783820.dkr.ecr.ap-southeast-1.amazonaws.com"
    REPO_NAME     = "movie-review"
    IMAGE_TAG     = "${env.BUILD_NUMBER}"
    FULL_IMAGE    = "${ECR_REGISTRY}/${REPO_NAME}:${IMAGE_TAG}"
    APP_DIR       = "javaapp-standalone"
    APP_NAMESPACE = "app"
    APP_PORT      = "8080"
  }

  stages {

    stage('Checkout') {
      steps {
        container('maven') {
          // explicit checkout (skipDefaultCheckout() prevents automatic checkout)
          checkout scm
          sh "echo 'Contents of ${APP_DIR}:' && ls -la ${APP_DIR} || true"
        }
      }
    }

    stage('Build + ECR Prep (parallel)') {
      parallel {
        stage('Build - Maven') {
          steps {
            container('maven') {
              dir("${APP_DIR}") {
                sh 'mvn -B -DskipTests clean package'
              }
            }
          }
        }

        stage('Ensure ECR') {
          steps {
            container('aws') {
              // if aws credentials are set in secret, this will succeed.
              sh '''
                aws --version || true
                aws ecr describe-repositories --repository-names ${REPO_NAME} --region ${AWS_REGION} || \
                aws ecr create-repository --repository-name ${REPO_NAME} --region ${AWS_REGION}
              '''
            }
          }
        }
      }
    }

      stage('Build & Push Image (Kaniko)') {
        steps {
          container('kaniko') {
            sh """
              echo 'Working directory:' 
              echo ${WORKSPACE}
              echo 'Listing:'
              ls -la ${WORKSPACE}/${APP_DIR}
      
              # validate Dockerfile exists
              if [ ! -f ${WORKSPACE}/${APP_DIR}/Dockerfile ]; then
                 echo "ERROR: Dockerfile not found at ${WORKSPACE}/${APP_DIR}/Dockerfile"
                 exit 1
              fi
      
              /kaniko/executor \
                --context=dir://${WORKSPACE}/${APP_DIR} \
                --dockerfile=${WORKSPACE}/${APP_DIR}/Dockerfile \
                --destination=${FULL_IMAGE} \
                --verbosity=info
            """
          }
        }
      }


    stage('Helm Deploy') {
      steps {
        container('helm') {
          sh """
            kubectl get ns ${APP_NAMESPACE} || kubectl create ns ${APP_NAMESPACE}
            helm upgrade --install ${REPO_NAME} ${APP_DIR}/helm \
              --namespace ${APP_NAMESPACE} \
              --set image.repository=${ECR_REGISTRY}/${REPO_NAME} \
              --set image.tag=${IMAGE_TAG} \
              --set service.port=${APP_PORT}
          """
        }
      }
    }
  }

  post {
    success {
      echo "SUCCESS → Image pushed: ${FULL_IMAGE}"
    }
    failure {
      echo "FAILED → Check Maven / AWS / Kaniko / Helm logs"
    }
  }
}
